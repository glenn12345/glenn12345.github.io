<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>redis | Glenn</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">redis</h1><a id="logo" href="/.">Glenn</a><p class="description">你站在桥上看风景，看风景的人在楼上看你</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">redis</h1><div class="post-meta">Apr 4, 2019<span> | </span><span class="category"><a href="/categories/redis/">redis</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2019/04/04/redis事物操作/" href="/2019/04/04/redis事物操作/#comments" class="ds-thread-count"></a><div class="post-content"><h3 id="redis-事物操作"><a href="#redis-事物操作" class="headerlink" title="redis 事物操作"></a>redis 事物操作</h3><hr>
<ul>
<li>为了确保连续多个操作的原子性，一个成熟的数据库通常都会有事物支持，Redis也不不例外。Redis 的事务使用非常简单，不同于关系数据库，我们无须理解那么多复杂的事务模型，就可以直接使用。不过也正是因为这种简单性，它的事务模型很不严格，这要求我们不能像使用关系数据库的事务一样来使用 Redis。</li>
</ul>
<h4 id="Redis-事务的基本使用"><a href="#Redis-事务的基本使用" class="headerlink" title="Redis 事务的基本使用"></a>Redis 事务的基本使用</h4><ul>
<li>每个事务的操作都有 begin、commit 和 rollback，begin 指示事务的开始，commit 指示事务的提交，rollback 指示事务的回滚。</li>
<li><p><strong>Redis</strong> 在形式上看起来也差不多，分别是 multi/exec/discard。multi 指示事务的开始，exec 指示事务的执行，discard 指示事务的丢弃。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; multi</div><div class="line">OK</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; exec</div><div class="line">(integer) 1</div><div class="line">(integer) 2</div></pre></td></tr></table></figure>
</li>
<li><p>上面的指令演示了一个完整的事务过程，所有的指令在 exec 之前不执行，而是缓存在服务器的一个事务队列中，服务器一旦收到 exec 指令，才开执行整个事务队列，执行完毕后一次性返回所有指令的运行结果。因为 Redis 的单线程特性，它不用担心自己在执行队列的时候被其它指令打搅，可以保证他们能得到的「原子性」执行。</p>
</li>
</ul>
<h4 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h4><ul>
<li><p>事务的原子性是指要么事务全部成功，要么全部失败，那么 Redis 事务执行是原子性的么？</p>
<p>下面我们来看一个特别的例子。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt; multi</div><div class="line">OK</div><div class="line">&gt; set books iamastring</div><div class="line">QUEUED</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; set poorman iamdesperate</div><div class="line">QUEUED</div><div class="line">&gt; exec</div><div class="line">1) OK</div><div class="line">2) (error) ERR value is not an integer or out of range</div><div class="line">3) OK</div><div class="line">&gt; get books</div><div class="line">&quot;iamastring&quot;</div><div class="line">&gt;  get poorman</div><div class="line">&quot;iamdesperate</div></pre></td></tr></table></figure>
<ul>
<li>上面的例子是事务执行到中间遇到失败了，因为我们不能对一个字符串进行数学运算，事务在遇到指令执行失败后，后面的指令还继续执行，所以 poorman 的值能继续得到设置。</li>
</ul>
<hr>
<ul>
<li>到这里，你应该明白 Redis 的事务根本不能算「原子性」，而仅仅是满足了事务的「隔离性」，隔离性中的串行化——当前执行的事务有着不被其它事务打断的权利。</li>
</ul>
<h4 id="discard-丢弃"><a href="#discard-丢弃" class="headerlink" title="discard(丢弃)"></a>discard(丢弃)</h4><hr>
<ul>
<li><p>Redis 为事务提供了一个 discard 指令，用于丢弃事务缓存队列中的所有指令，在 exec 执行之前。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; get books</div><div class="line">(nil)</div><div class="line">&gt; multi</div><div class="line">OK</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; discard</div><div class="line">OK</div><div class="line">&gt; get books</div><div class="line">(nil)</div></pre></td></tr></table></figure>
</li>
<li><p>我们可以看到 discard 之后，队列中的所有指令都没执行，就好像 multi 和 discard 中间的所有指令从未发生过一样。</p>
</li>
</ul>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><ul>
<li>上面的 Redis 事务在发送每个指令到事务缓存队列时都要经过一次网络读写，当一个事务内部的指令较多时，需要的网络 IO 时间也会线性增长。所以通常 Redis 的客户端在执行事务时都会结合 pipeline 一起使用，这样可以将多次 IO 操作压缩为单次 IO 操作。比如在使用 Python 的 Redis 客户端时执行事务时是要强制使用 pipeline 的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pipe = redis.pipeline(transaction=true)</div><div class="line">pipe.multi()</div><div class="line">pipe.incr(&quot;books&quot;)</div><div class="line">pipe.incr(&quot;books&quot;)</div><div class="line">values = pipe.execute()</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Watch"><a href="#Watch" class="headerlink" title="Watch"></a>Watch</h4><hr>
<ul>
<li>考虑到一个业务场景，Redis 存储了我们的账户余额数据，它是一个整数。现在有两个并发的客户端要对账户余额进行修改操作，这个修改不是一个简单的 incrby 指令，而是要对余额乘以一个倍数。Redis 可没有提供 multiplyby 这样的指令。我们需要先取出余额然后在内存里乘以倍数，再将结果写回 Redis。</li>
<li>这就会出现并发问题，因为有多个客户端会并发进行操作。我们可以通过 Redis 的分布式锁来避免冲突，这是一个很好的解决方案。<strong>分布式锁是一种悲观锁，那是不是可以使用乐观锁的方式来解决冲突呢？</strong></li>
</ul>
<hr>
<ul>
<li>Redis 提供了这种 watch 的机制，它就是一种乐观锁。有了 watch 我们又多了一种可以用来解决并发修改的方法。 watch 的使用方式如下：</li>
</ul>
<hr>
<ul>
<li><p>watch 会在事务开始之前盯住 1 个或多个关键变量，当事务执行时，也就是服务器收到了 exec 指令要顺序执行缓存的事务队列时，Redis 会检查关键变量自 watch 之后，是否被修改了 (包括当前事务所在的客户端)。如果关键变量被人动过了，exec 指令就会返回 null 回复告知客户端事务执行失败，这个时候客户端一般会选择重试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; watch books</div><div class="line">OK</div><div class="line">&gt; incr books  # 被修改了</div><div class="line">(integer) 1</div><div class="line">&gt; multi</div><div class="line">OK</div><div class="line">&gt; incr books</div><div class="line">QUEUED</div><div class="line">&gt; exec  # 事务执行失败</div><div class="line">(nil)</div></pre></td></tr></table></figure>
</li>
<li><p>当服务器给 exec 指令返回一个 null 回复时，客户端知道了事务执行是失败的，通常客户端 (redis-py) 都会抛出一个 WatchError 这种错误，不过也有些语言 (jedis) 不会抛出异常，而是通过在 exec 方法里返回一个 null，这样客户端需要检查一下返回结果是否为 null 来确定事务是否执行失败。Redis 禁止在 multi 和 exec 之间执行 watch 指令，而必须在 multi 之前做好盯住关键变量，否则会出错。</p>
</li>
</ul>
<h4 id="redis-为什么不支持回滚"><a href="#redis-为什么不支持回滚" class="headerlink" title="redis 为什么不支持回滚"></a>redis 为什么不支持回滚</h4><ul>
<li>不支持回滚操作是因为redis是先执行指令然后做日志，所以即使发生异常，没有可以用来执行回滚操作的日志。传统的数据库都是先做日志然后再做操作。</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2019/04/04/redis事物操作/" data-id="ck7wpukfw000ed7esimtq0a2k" class="article-share-link">分享到</a><div class="tags"><a href="/tags/redis事物/">redis事物</a></div><div class="post-nav"><a href="/2019/04/26/redis-HyperLogLog/" class="pre">redis</a><a href="/2019/03/28/redis分布式锁/" class="next">redis</a></div><div data-thread-key="2019/04/04/redis事物操作/" data-title="redis" data-url="http://yoursite.com/2019/04/04/redis事物操作/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2019/04/04/redis事物操作/" data-title="redis" data-url="http://yoursite.com/2019/04/04/redis事物操作/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/搜索引擎/" style="font-size: 15px;">搜索引擎</a> <a href="/tags/Node/" style="font-size: 15px;">Node</a> <a href="/tags/yii2/" style="font-size: 15px;">yii2</a> <a href="/tags/homebrew/" style="font-size: 15px;">homebrew</a> <a href="/tags/redis-HypreLogLog/" style="font-size: 15px;">redis HypreLogLog</a> <a href="/tags/redis分布式锁/" style="font-size: 15px;">redis分布式锁</a> <a href="/tags/redis事物/" style="font-size: 15px;">redis事物</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/26/redis-HyperLogLog/">redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/04/redis事物操作/">redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/redis分布式锁/">redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/05/JWT入门/">elasticSearch</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/05/elasticSearch初识/">elasticSearch</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/28/Homebrew更新问题/">Homebrew更新问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/18/Node-js事件驱动函数应用/">Node.js事件驱动函数应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/15/Yii-froeach/">Yii-froeach</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.runoob.com/" title="菜鸟教程" target="_blank">菜鸟教程</a><ul></ul><a href="http://www.jikedaohang.com/" title="极客导航" target="_blank">极客导航</a><ul></ul><a href="http://stormzhang.com/" title="stormzhang" target="_blank">stormzhang</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Glenn.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'glenn123'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>